

# Kernel and user space
![[Pasted image 20241006232953.png]]
A modern operating system uses virtual memory to provide separate address spaces/regions of memory for a single address space, called the **kernel space** and **user space**.

### Kernel space
Reserved for running a privileged operating system kernel , kernel extensions, and most device drivers. Includes process scheduling, scheduling daemons, memory management subsystem etc.
This code runs in 'kernel mode', ie a privileged mode of operation.
### User space
Refers to the address space reserved for running all  code outside of the operating system kernel. This code runs in 'user mode' which means there is CPU flag telling it not to allow the use of privileged instructions, and access kernel memory.


## Interrupts
An interrupt is a mechanism for altering the normal flow of execution; it is a signal sent directly to processor.
Can happen asynchronously, triggered by unpredictable factors external to the CPU such as user input. 
Can also happen synchronously, triggered directly by the CPU executing an instruction. 

### Interrupt mechanism overview
1. CPU is executing instructions
2. Interrupt generated by some hardware device to indicate some I/O data is available
3. CPU checks if interrupts are enabled, if so, pauses execution, .
4. Saves state e.g., program counter, registers and switches to kernel mode and runs code in a handler to service the interupt
5. Returns to processing

### Problems with interrupts
- Interrupts can come at any time, and handling them should not take long. 
	- Handlers may split work into a top component dealt with immediately, and a bottom component scheduled to be dealt with later. 
- Interrupts may also be interrupted by other interrupts; it must therefore be possible to nest interrupt handlers.
- Some critical code must never be interrupted and interrupts must be disabled.

## Exception
Event that occurs during process execution, caused typically by software errors or specific conditions e.g., illegal memory access. Typically triggered by running program itself. Alter the flow of control in the program itself. If unhandled, may result in program termination.

### System calls
> The fundamental interface between a user space application and the kernel.

At a high level, it is how programs request services from the kernel. Sys calls are relied on to perform privileged kernel-mode operations like interacting with hardware or accessing critical system resources.

We can distinguish between an API and system call.
- An API is a programming interface, typically a library of functions that run in user space e.g., pthreads
- An API is a high level abstraction, that may need to make multiple system calls to provide the required functionality. 
- A single API function may invoke zero, one or many system calls

### System call process(naive sketch) (implemented in terms of interrupt here)
1. User code running
2. System call required for some privileged function alit - each has unique number
3. Number stored in designated register
4. Parameters for system call stored in designated registers
5. Synchronous interrupt (software) triggered by an instruction referred to as a trap
6. CPU saves state and switches to kernel mode
7. Transfers control to trap handler, which calls system call service routine delivering required functionality
## Use of C for OS implementation
### Performance
- Cannot sacrifice correctness
- Bias toward performance over simplicity
- A slow OS slows every program it runs
### Portability
- Reuse is desirable
- Must run directly on hardware - no interpreted languages
- Ideally must be able to compile for multiple hardware platforms
### Predictability
- OS behaviour must be predictable
- Unpredictable behaviour such as garbage collection and other things outside of direct control are inappropriate
- 

